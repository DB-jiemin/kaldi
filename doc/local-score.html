#!/bin/bash<br># Copyright 2012  Johns Hopkins University (Author: Daniel Povey)<br>#           2014  Guoguo Chen<br># Apache 2.0<br><br>[ -f ./path.sh ] && . ./path.sh<br><br># begin configuration section.<br>cmd=run.pl<br>stage=0<br>decode_mbr=true<br>word_ins_penalty=0.0,0.5,1.0<br>min_lmwt=7<br>max_lmwt=17<br>iter=final<br>#end configuration section.<br><br>[ -f ./path.sh ] && . ./path.sh<br>. parse_options.sh || exit 1;<br><br>if [ $# -ne 3 ]; then<br>echo "Usage: local/score.sh [--cmd (run.pl|queue.pl...)] <data-dir> <lang-dir|graph-dir> <decode-dir>"<br>echo " Options:"<br>echo "    --cmd (run.pl|queue.pl...)      # specify how to run the sub-processes."<br>echo "    --stage (0|1|2)                 # start scoring script from part-way through."<br>echo "    --decode_mbr (true/false)       # maximum bayes risk decoding (confusion network)."<br>echo "    --min_lmwt <int>                # minumum LM-weight for lattice rescoring "<br>echo "    --max_lmwt <int>                # maximum LM-weight for lattice rescoring "<br>exit 1;<br>fi<br><br>data=$1<br>lang_or_graph=$2<br>dir=$3<br><br>symtab=$lang_or_graph/words.txt<br><br>for f in $symtab $dir/lat.1.gz $data/text; do<br>[ ! -f $f ] && echo "score.sh: no such file $f" && exit 1;<br>done<br><br>mkdir -p $dir/scoring/log<br><br>cat $data/text | sed 's:<NOISE>::g' | sed 's:<SPOKEN_NOISE>::g' > $dir/scoring/test_filt.txt<br><br>for wip in $(echo $word_ins_penalty | sed 's/,/ /g'); do<br>$cmd LMWT=$min_lmwt:$max_lmwt $dir/scoring/log/best_path.LMWT.$wip.log \<br>lattice-scale --inv-acoustic-scale=LMWT "ark:gunzip -c $dir/lat.*.gz|" ark:- \| \<br>lattice-add-penalty --word-ins-penalty=$wip ark:- ark:- \| \<br>lattice-best-path --word-symbol-table=$symtab \<br>ark:- ark,t:$dir/scoring/LMWT.$wip.tra || exit 1;<br>done<br><br># Note: the double level of quoting for the sed command<br>for wip in $(echo $word_ins_penalty | sed 's/,/ /g'); do<br>$cmd LMWT=$min_lmwt:$max_lmwt $dir/scoring/log/score.LMWT.$wip.log \<br>cat $dir/scoring/LMWT.$wip.tra \| \<br>utils/int2sym.pl -f 2- $symtab \| sed 's:\<UNK\>::g' \| \<br>compute-wer --text --mode=present \<br>ark:$dir/scoring/test_filt.txt  ark,p:- ">&" $dir/wer_LMWT_$wip || exit 1;<br>done<br><br>exit 0;<br>
